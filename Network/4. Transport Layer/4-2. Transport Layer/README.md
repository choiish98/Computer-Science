## (4) 전송 계층
### (1) 전송 계층
#### (1) UDP 프로토콜
**UDP**는 인터넷에서 사용하는 프로토콜 중 가장 구조가 간단하다. 하부의 IP 프로토콜을 이용해 비연결형 서비스를 지원하는 UDP는 작지만 빠른 전송이 가능하며, 다음과 같은 특징이 있다.
- 비연결형 서비스를 제공한다.
- 헤더와 전송 데이터에 대한 체크섬 기능을 제공한다.
- Best Effort 전달 방식을 지원한다.

UDP는 상위 계층에서 받은 데이터를 IP 프로토콜에 전달하지만, `전송한 데이터그램이 목적지까지 제대로 도착했는지 확인하지 않는다.` 따라서 TCP보다 신뢰성이 떨어져 일반 응용 프로그래머들 사이에서 덜 선호되고 있다. 하지만 `프로토콜을 처리하는 기능이 작아 TCP보다 데이터 처리가 빠르므로` 데이터 전송 시간에 민감한 응용 환경에서 UDP를 사용하는 것이 유리하다.

##### (1) UDP 헤더 구조
![10-1  UDP 헤더 구조](https://user-images.githubusercontent.com/56579239/163678850-12adfa8f-b07d-4e7f-b367-e96d5f673752.jpg)

- **Source Port/Destination Port**: 송수신 프로세스에 할당단 네트워크 포트 번호이다.
- **Length**: 프로토콜 헤더를 포함한 UDP 데이터그램의 전체 크기이다.
- **Checksum**: 체크섬 값을 제공하여 수신 프로세스가 데이터그램 변형 오류를 감지할 수 있다.

UDP는 TCP보다 구조가 아주 단순해 전송 효율이 좋으며, 고속 전송이 필요한 환경에 유용하다. 특히 덩치가 큰 TCP를 구현하기에는 메모리 등이 작은 네트워크 장비에서 사용하기 적합하다.

##### (2) UDP의 데이터그램 전송
UDP는 `비연결형 서비스`를 이용하여 데이터그램을 전송하며, `각 데이터그램은 전송 과정에서 독립적으로 중개`된다. 그리고 데이터그램이 목적지까지 도착할 수 있도록 최선을 다하지만, 반드시 목적지에 도착하는 것을 보장하지 않는다. 또한 흐름 제어 기능도 제공하지 않아, 버퍼 오버플로우에 의한 데이터 분실 오류가 발생할 수 있다.

이와 같은 이유로 UDP를 사용해 데이터그램을 전송할 때는 오류 발생 가능성을 항상 염두에 두어야 한다. 오류 유형은 데이터가 목적지에 도착하지 못하는 데이터그램 분실과 데이터그램의 도착 순서가 바뀌는 도착 순서 변경으로 나뉜다.

###### (1) UDP에서의 데이터그램 분실
송신 프로세스가 전송한 데이터그램이 첫 번째 라우터에서 두 번째 라우터로 전송되는 과정에서 일부 데이터그램에 오류가 발생하여 다음 라우터에 도착하지 못 하는 상황에서, UDP는 분실 오류를 복구하는 기능을 수행하지 않으므로 수신 프로세스에는 분실 데이터를 제외한 데이터그램만 도착한다. UDP에서의 데이터그램 분실 오류는 상위 계층 스스로 데이터 분실을 확인해 복구해야 한다.

UDP 헤더 구조에서 알 수 있듯이, 데이터의 순서 번호 기능을 제공하지 않으므로 데이터그램 분실 여부를 확인할 수 없다. 따라서 응용 프로그램에서 데이터 분실을 감지하려면 순서 번호와 유사한 기능을 프로그램 내부에 구현해야 한다.

###### (2) UDP에서의 데이터그램 도착 순서 변경
UDP에서는 각 데이터그램을 개별 전송 경로를 선택하여 전송한다. 따라서 각 데이터그램은 서로 다른 경로로 전송될 수 있다. 또한 각 경로에서 데이터를 얼마나 빠르게 전송할 지 예측할 수 없기 때문에, 순서가 변경될 수 있다.

데이터 분실 오류의 경우와 마찬가지로 도착 순서 변경 오류를 해결할 수 없는 이유는 데이터의 순서 번호 기능이 없기 때문이다. 도착 순서 변경 오류를 해결하려면 UDP를 사용하는 응용 프로그램의 내부에서 순서 번호 기능이 구현되어야 한다.

#### (2) RTP 프로토콜
기존의 TCP와 UDP는 실시간 서비스가 요규하는 전송 특성을 충분히 지원하지 못한다. TCP는 패킷의 순서와 신뢰성이 지나치게 강조되어, 재전송 기능과 복잡한 흐름 제어 기능으로 인해 실시간 환경에는 부적합하다.

UDP는 기능이 단순하여 빠른 데이터 전송을 지원하지만, 데이터그램의 순서를 보장하지 못 한다는 문제가 있다. 따라서 실시간 데이터 전송 서비스의 특성을 지원할 수 있는 새로운 형태의 프로토콜이 필요하다.

실시간 서비스를 제공하는 가장 현실적인 방법 중 하나는 `UDP에 데이터그램 순서 번호 기능을 추가하는 것`이다. 이러한 프로토콜의 대표적인 예가 실시간 멀티미디어 데이터 전송을 지원하는 **RTP**이다. RTP는 유티캐스팅뿐 아니라 멀티캐스팅도 지원한다. RTP의 특징은 다음과 같다.

- 불규칙하게 수신되는 데이터의 순서를 정렬하기 위해 `타임스탬프 방식을 사용`한다.
- 프로토콜의 동작이 응용 프로그램의 라이브러리 형태로 구현되는 ALF 방식을 사용하기 때문에, 프로토콜 내부에 위치하는 버퍼의 크기를 각 응용 프로그램마다 별도로 관리하기가 용이하다. 따라서 `응용 환경이 요구하는 알고리즘에 따라 버퍼 크기를 개별적으로 조절`할 수 있다.

##### (1) 실시간 요구 사항
실시간 서비스는 전송 시간이 중요하다. 송신 프로세스가 전송한 데이터의 전송 간격이 수신 프로세스에 그대로 유지되록 하는 것이 중요하며, 대부분 특정 데이터가 정해진 시간 안에 반드시 도착하도록 요구한다. 특정 시간을 초과하여 도착한 데이터는 결과적으로 무용지물이 되고 만다.

###### (1) 버퍼의 역할

![10-2  실시간 전송](https://user-images.githubusercontent.com/56579239/163678857-2277c11b-5152-465a-accd-5f34aecb263a.jpg)

다음은 전형적인 실시간 응용 환경에서 데이털르 전송하는 원리를 설명한다. 송신 프로세스가 전송한 데이터는 데이터그램 사이의 시간 간격이 일정하다가 인터넷을 거쳐 수신 프로세스에 전달되는 과정에서 간격이 불규칙하게 변한다.

수신 측에서는 시간 간격이 가변적인 데이터를 수신 프로세스에 즉시 전송하지 않고, 지연 버퍼를 사용해 데이터의 시간 간격을 일정하게 보정한다. 이때 수신 프로세스에 도착한 데이터의 시간이 실시간 재생에서 요구하는 일정 범위보다 늦으면 해당 데이터를 버린다. 위에서 회색으로 표시한 데이터그램이 이에 해당한다.

###### (2) 지터
주어진 시간안에 데이터 전송을 완료하기 위한 기본 조건은 전송 대역폭을 충분히 확보하는 것이다. 이를 일반적인 관점으로 표현하면 송수신 프로세스 사이의 **지연** 시간에 관한 문제라 표현하기도 한다.

지연은 `송신 프로세스가 전송한 데이터의 출발 시간과 수신 프로세스에 도착한 시간의 차이이다.` 지연에 영향을 미치는 요소에는 대역폭뿐 아니라, 네트워크의 구조, 라우팅 방식, 전송 프로토콜의 종류 등 여러 가지가 있다.

![10-3  지터 분포](https://user-images.githubusercontent.com/56579239/163678864-1b3b584d-c1e1-4c66-bda6-2be48352a790.jpg)

실시간 데이터를 전송하는 환경에서는 **지터**라는 중요한 변수를 고려해야 한다. **지터 분포**는 데이터그램의 도착 시간을 측정하였을 때 각 데이터그램의 도착 시간이 일정하지 않고 불규칙적으로 도착하는 정도를 나타낸다.

##### (2) RTP의 데이터 전송

![10-4  RTP 구조](https://user-images.githubusercontent.com/56579239/163678865-808c2b79-b23b-43ed-ab87-502ff5255b5a.jpg)

다음은 RTP의 동작 원리를 설명한다. RTP는 실시간 서비스를 제공하기 위해 작고 빠른 전송 기능을 제공하는 UDP 위에서 구현된다. 따라서 비연결형 서비스를 제공하는 UDP의 데이터그램 분실이나 도착 순서 변경과 같은 전송 오류는 RTP 자체에서 해결한다. 그리고 UDP에서 제공하는 포트 주소 기능 등을 사용해 송수신 프로세스 간의 연결을 관리한다.

RTP는 하나의 완전한 프로그램 단위로 구현되지 않고, 기능별로 개별적으로 구현된다. 각각의 응용 서비스의 종류에 따라 요구 조건이 다른 기능들이 추가되는 형식으로 완전한 RTP 모듈이 완성된다. 이를 위해 RTP 헤더 부분에 첨삭이 용이하도록 설계된다.

RTP는 다수의 사용자가 하나의 세선에 참여해 서로 실시간 데이터를 전송하도록 지원한다. RTP에서 의미하는 세션은 RTP 참가자 사이의 연관성으로 그룹을 형성하여 멀티캐스트 전송을 지원하기 위한 것이다.

RTP는 믹서와 트랜스레이터라는 두 종류의 RTP 릴레이를 지원한다. 릴레이는 데이터 전송 과정에서 송수신 프로세스가 데이터를 직접 전송할 수 없는 상황이 발생했을 때, 데이터를 중개하는 기능이다. 
- **믹서**: 믹서는 여러 송신 프로세스로부터 RTP 데이터그램 스트림을 받아 이들을 적절히 조합하여 새로운 데이터그램 스트림을 생성한다. 이 과정에서 데이터 형식이 변하거나 믹싱 기능이 수행될 수 있다. 여러 송신 프로세스로부터 수신된 데이터의 시간 관계가 적절하게 조절되지 않을 수 있기 때문에 조합된 데이터그램 스트림에 시간 정보를 제공한다. 또한 자신이 해당 데이터그램의 시간 정보를 제공했음을 표시해야 한다. 이렇게 만들어진 데이터그램 스트림은 여러 수신 프로세스에 전달된다.
- **트랜스레이터**: 입력된 각 RTP 데이터그램을 하나 이상의 출력용 RTP 데이터그램으로 만들어주는 장치로, 이 과정에서 데이터 형식이 변할 수 있다. 예를 들어, 임의의 수신자 그룹에서 특정 수신 프로세스가 고해상도 비디오 신호를 처리할 능력이 없으면, 트랜스레이터가 이를 저해상도 신호로 변환하여 수신 프로세스가 처리할 수 있 도록 도와준다.

스트림은 데이터그램을 연속으로 전송한다는 의미인데, 연속 데이터그램은 시간에 민감하다. 믹서는 데이터그램 스트림의 믹싱에 관한 문제를 다루는 반면, 트랜스레이터는 스트림에는 관심 없고 특정한 변환 작업을 수행한다.

##### (3) RTP의 헤더 구조

![10-5  RTP 헤더 구조](https://user-images.githubusercontent.com/56579239/163678873-bfd7c446-6ec9-46e6-b4ee-30dc8179d208.jpg)

다음은 RTP 헤더의 기본 구조이다. 여기에 응용 환경과 관련된 가변 크기의 헤더를 추가할 수 있다. 처음 12바이트의 정보는 모든 RTP 패킷에 존재하며, CSRC 구분자 목록은 믹서에 의해 추가되는 경우에 사용된다. RTP는 음성과 영상 데이터의 동기에 필요한 시간정보와 데이터그램으 ㅣ분실이나 도착 순서 변경 등의 오류를 검출하는 기능을 제공한다.

유니캐스트와 실시간 전송에 사용되는 RTP의 또 다른 특징은 멀티캐스트 전송도 가능하다는 것이다. 이를 위해 RTP 데이터 형식에는 멀티캐스트 그룹에서 누가 데이터를 전송했는지를 확인하는 송신 구분자 필드가 존재한다. 또한 수신 프로세스에서 지연 버퍼를 사용해 타이밍 관계를 조절할 수 있도록 Timestamp 필드도 지원된다.

- **Version**: RTP의 버전 번호이며, 현재 2로 지정된다.
- **Padding**: RTP 페이로드의 마지막에 패딩 데이터가 존재하는지 여부를 나타낸다. 응용 환경에서 페이로드의 크기가 특정 크기의 배수가 되어야 할 때 사용한다.
- **Extension**: 고정 헤더의 마지막에 확장 헤더가 하나 더 이어짐을 의미한다.
- **CSRC Count**: CSRC 구분자의 개수를 표시한다.
- **Marker**: 임의의 표식을 위해 이용하므로, 페이로드 유형에 따라 값의 의미가 결정된다. 보통 데이터 스트림의 경계점을 표시하는 데 사용한다.
- **Payload Type**: 헤더 다음에 이어지는 RTP 페이로드의 유형을 나타낸다. 예를 들어, RTP 페이로드가 JPEG 영상인 경우에 그에 대해 표시할 수 있다.
- **Sequence Number**: Timestamp 필드 값이 동일한 페이로드에 대해 패킷 손실이나 순서 변경과 같은 오류를 검출할 수 있도록 한다.
- **Timestamp**: RTP 페이로드에 포함된 데이터의 생성 시기를 나타낸다. 시간 단위는 페이로드의 종류에 영향을 받으며, 송신 프로세스에서 사용하는 클록에 의해 발생한다.
- **SSRC Identifier**: 임의의 세션 내에서 RTP 페이로드의 발신지가 어디인지를 구분하는 고유 번호로, 랜덤하게 생성되는 32비트 숫자이다.

##### (4) RTP 제어 프로토콜
RTP 제어 프로토콜을 RTP 데이터 전송 프로토콜과 구분하기 위해 RTCP라 부른다. 데이터 전송 프로토콜은 세션 참가자 사이의 멀티캐스트 기능을 이용한 사용자 데이터의 전송을 담당하지만 RTCP는 제어와 관련된 기능을 수행한다. RTCP에서 제공하는 주요 기능은 다음과 같다.
- **QoS와 혼잡제어**: RTCP는 세션에서의 데이터 분배 과정에서 발생하는 서비스 품질에 관한 피드백 기능을 지원한다. 멀티캐스팅 과정에서 세션 멤버의 데이터 송수신 과정이 어떻게 이루어졌는지를 판단하는데, 이를 위해서 송수신 프로세스가 관련 보고서를 작성한다. 송신 프로세스의 보고서에는 전송률 등의 정보가 포함되고, 수신 프로세스의 보고서에는 수신 과정에서 발생하는 패킷 분실이나 지터 등의 정보가 포함된다.
- **Identification**: RTCP 패킷에는 RTCP 송신 프로스셍 관한 구분자 정보가 포함되며, 서로 다른 세션에서 발신된 정보들을 서로 연관시키는 근거를 제공한다.
- **세션 크기**: RTCP의 기능이 올바로 동작하기 위해서는 세션 참가자들 사이에 RTCP 패킷이 주기적으로 전송되어야 한다. 세션 참가자의 수가 증가함에 따라 RTCP 패킷의 전송률은 감소할 수 밖에 없다. RTCP 패킷의 트래픽이 많아지면 세션 전체의 트래픽도 증가하기 때문에 이를 제한하는데, 일반적으로 전체 세션 트래픽의 5% 이내로 유지되도록 알고리즘이 동작한다.

#### (3) OSI TP 프로토콜
OSI에서 정의한 TP는 다섯 개의 클래스로 서비스를 분류하여 지원한다.
- 클래스 0: 기본 전송 기능
- 클래스 1: 기번 오류 복구 기능
- 클래스 2: 멀티플렉싱 기능
- 클래스 3: 오류 복구, 멀티플렉싱 기능
- 클래스 4: 오류 검출, 오류 복구, 멀티플렉싱 기능

##### (1) OSI TP의 서비스 프리미티브
TP가 상위 계층에 제공하는 전송 서비스에는 연결형과 비연결형이 있다. 연결형 서비스는 연결 설정과 연결 해제, 일반 데이터와 긴급 데이터를 나타내는 프리미티브가 존재한다. 전송 계층의 연결형 프로토콜은 상위 게층에 전송 오류가 없는 서비스를 제공하기 때문에 데이터에 대한 긍정 응답이나 부정 응답 프레임은 정의되지 않는다. 비연결형 서비스는 연결 설정과 해제 과정이 불필요하므로 데이터 전송을 위한 프리미티브만 존재한다.

###### (2) OSI TP의 데이터 전송
![10-6  OSI 프리미티브](https://user-images.githubusercontent.com/56579239/163678875-13e65d4c-5925-47a6-be41-6cf961d5e3c0.jpg)
